<!DOCTYPE html>

<html>
<head>
  <title>Coffee-Formatter</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          
          <h1>Coffee-Formatter</h1>
<h2>Introduction</h2>
<p>CoffeeFormatter (abbreviated as CF) is a, guess what, formatter for CoffeeScript.  Let me know if you were actually expecting otherwise lol.</p>
<p>The code is written in Literate CoffeeScript.  Checkout Wikipedia for what &quot;Literate Programming&quot; means.</p>
<h2>Code</h2>
<h3>Dependencies</h3>
<p>CF relies on the following packages:</p>
<ul>
<li><code>lazy</code> for reading files line by line.  An example is given <a href="http://stackoverflow.com/questions/6156501/read-a-file-one-line-at-a-time-in-node-js">here</a>.</li>
<li><code>fs</code> for file io.</li>
<li><code>optimist</code> for command line parsing.</li>
</ul>
<p>Code:</p>

          
            <div class='highlight'><pre>Lazy = require <span class="string">'lazy'</span>
fs = require <span class="string">'fs'</span></pre></div>
          
        

        
      </div>

      
        
        <p>By default, we use a tab width of 2 and use spaces exclusively.  This is the style most widely used in the community.  For a detailed guide of CoffeeScript style, check out <a href="https://github.com/polarmobile/coffeescript-style-guide">this</a>.</p>

        
          <div class='highlight'><pre>argv = (require <span class="string">'optimist'</span>)
  .<span class="reserved">default</span>(<span class="string">'tab-width'</span>, <span class="number">2</span>)
  .<span class="reserved">default</span>(<span class="string">'use-space'</span>, <span class="literal">true</span>)
  .argv</pre></div>
        
      
        
        <h3>Constants</h3>
<p>We define a set of constants, including:</p>
<p>Two-space operators.  These operators should have one space both before and after.</p>

        
          <div class='highlight'><pre>TWO_SPACE_OPERATORS = [<span class="string">'='</span>, <span class="string">'+='</span>, <span class="string">'-='</span>, <span class="string">'=='</span>, <span class="string">'&lt;='</span>, <span class="string">'&gt;='</span>,
                    <span class="string">'&gt;'</span>, <span class="string">"&lt;"</span>, <span class="string">'+'</span>, <span class="string">'-'</span>, <span class="string">'*'</span>, <span class="string">'/'</span>]</pre></div>
        
      
        
        <p>One-space operators.  They should have one space after.</p>

        
          <div class='highlight'><pre>ONE_SPACE_OPERATORS = [<span class="string">':'</span>, <span class="string">'?'</span>, <span class="string">''</span>]</pre></div>
        
      
        
        <h3>Helper Functions</h3>
<p><code>getExtension()</code> returns the extension of a filename, excluding the dot.</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">getExtension</span></span> = (filename) -&gt;
  i = filename.lastIndexOf <span class="string">'.'</span>
  <span class="keyword">return</span> <span class="keyword">if</span> i &lt; <span class="number">0</span> <span class="keyword">then</span> <span class="string">''</span> <span class="keyword">else</span> filename.substr (i+<span class="number">1</span>)</pre></div>
        
      
        
        <p><code>formatBinaryOperator()</code> takes in an operator and a line.  It assumes that the operator is an element of <code>BINARY_OPERATORS</code> and makes sure that there is one and only one space before and after the operator.  Before it inserts spaces, however, it makes sure that the operator in question is not part of a string.</p>
<p>This method is incomplete.</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">formatTwoSpaceOperator</span></span> = (operator, line) -&gt;
  index = line.indexOf(operator)
  <span class="keyword">if</span> notInString(index, line)
    <span class="keyword">if</span> line[index - <span class="number">1</span>] != <span class="string">' '</span></pre></div>
        
      
        
        <p>This method shortens consecutive spaces into one single space.</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">shortenSpaces</span></span> = (line) -&gt;
  prevChar = <span class="literal">null</span>
  newLine = <span class="string">''</span>
  <span class="keyword">for</span> c, i <span class="keyword">in</span> line
    <span class="keyword">unless</span> notInString(i, line) <span class="keyword">and</span> (c == <span class="string">' '</span> == prevChar)
      newLine += c
    prevChar = c</pre></div>
        
      
        
        <h3>Body</h3>
<p>The body of this module does the following:</p>
<ol>
<li>Parse command line.</li>
<li>Read the files specified by the user.</li>
<li>Perform formatting.</li>
</ol>
<p>We loop through <code>argv._</code>, which should be a list of filenames given by the user.</p>

        
          <div class='highlight'><pre><span class="keyword">for</span> filename <span class="keyword">in</span> argv._</pre></div>
        
      
        
        <p>Then we check if the extension is &quot;coffee&quot;.  Literate CoffeeScript will also be supported at some point.</p>

        
          <div class='highlight'><pre>  <span class="keyword">if</span> (getExtension filename) <span class="keyword">isnt</span> <span class="string">'coffee'</span>
    console.log
    <span class="string">"<span class="subst">#{filename}</span> doesn't appear to be a CoffeeScript file. Skipping..."</span>
    console.log <span class="string">"Use --force to format it anyway."</span></pre></div>
        
      
        
        <p>If the extension is &quot;coffee&quot;, we proceed to the actual formatting.</p>
<p>Firstly, we read the file line by line:</p>

        
          <div class='highlight'><pre>  <span class="keyword">else</span>
    file = <span class="string">''</span>

    <span class="keyword">new</span> Lazy(fs.createReadStream filename, encoding: <span class="string">'utf8'</span>)
      .lines
      .forEach (line) -&gt;
        newLine = line</pre></div>
        
      
        
        <p><code>newLine</code> is used to hold a processed line.  <code>file</code> is used to hold the processed file.</p>
<p>Now we add spaces before and after a binary operator, using the helper function:</p>

        
          <div class='highlight'><pre>        <span class="keyword">for</span> operator <span class="keyword">in</span> TWO_SPACE_OPERATORS
          newLine = formatTwoSpaceOperator operator, newLine</pre></div>
        
      
        
        <p>Do the same for single-space operators:</p>

        
          <div class='highlight'><pre>        <span class="keyword">for</span> operator <span class="keyword">in</span> ONE_SPACE_OPERATORS
          newLine = formatOneSpaceOperator operator, newLine</pre></div>
        
      
        
        <p>Shorten any consecutive spaces into a single space:</p>

        
          <div class='highlight'><pre>        newLine = shortenSpaces newLine
        file += newLine</pre></div>
        
      
        
        <p>After the <code>forEach</code> completes, we have a file that is formatted line by line.  However, a comprehensive formatter needs to consider the code in a block level.  Specifically:</p>
<ul>
<li>Indentation should be formatted according to the parameters specified by the user.</li>
</ul>

        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
